$(".alert").alert();$.Mustache.addFromDom();var marker;function showAlert(b){var a='<div class="row"><div class="col-md-10"><div id="alert-div" class="alert alert-warning alert-dismissable">';a+='<button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>';a+=b;a+="</div></div></div>";$(a).insertAfter("#location-input-row")}function populateTemplates(a){$.each(a.layers,function(b,d){var e={layername:d.layername};switch(d.layername.toLowerCase()){case"landscan population density 2011":for(var c=0;c<d.statistics.length;c++){if(d.statistics[c]["name"].toLowerCase()=="mean"){e.mean=Math.round(d.statistics[c]["value"]*10)/10}if(d.statistics[c]["name"].toLowerCase()=="minimum"){e.minimum=parseInt(d.statistics[c]["value"])}if(d.statistics[c]["name"].toLowerCase()=="maximum"){e.maximum=parseInt(d.statistics[c]["value"])}if(d.statistics[c]["name"].toLowerCase()=="standard deviation"){e.standarddeviation=Math.round(d.statistics[c].value+100)/100}}$("div.content-wrapper").append($.Mustache.render("landscan-template",e));break;case"global land cover map 2009":e.classes=[];d.classes.sort(function(g,f){if(g.areashare>f.areashare){return -1}if(g.areashare<f.areashare){return 1}return 0});for(var c=0;c<d.classes.length;c++){e.classes.push({areashare:Math.round(d.classes[c].areashare*10)/10,name:d.classes[c].name})}$("div.content-wrapper").append($.Mustache.render("landcover-template",e));break;case"accessibility: travel time to major cities":e.classes=[];d.classes.sort(function(g,f){if(g.areashare>f.areashare){return -1}if(g.areashare<f.areashare){return 1}return 0});for(var c=0;c<d.classes.length;c++){e.classes.push({areashare:Math.round(d.classes[c].areashare*10)/10,name:d.classes[c].name})}$("div.content-wrapper").append($.Mustache.render("accessibility-template",e));break;default:break}$(".row.stats-data-row:even > div").addClass("darker")})}function setLocation(d,c){$("div.loading").detach();$("div.stats-data").detach();if(map.hasLayer(marker)){map.removeLayer(marker)}var b='<div class="row loading"><div class="col-md-1 col-md-offset-5"><img width="36" height="39" src="img/spinner.gif" alt="Loading ..."></img></div></div>';$("div.content-wrapper").append(b);$("#longitude-input").val(Math.round(d*10000)/10000);$("#latitude-input").val(Math.round(c*10000)/10000);marker=L.marker(L.latLng(c,d));marker.on("click",function(f){map.removeLayer(marker);$("div.loading").detach();$("div.stats-data").detach();$("#longitude-input").val("");$("#latitude-input").val("");marker=undefined});marker.addTo(map);var a=$("#buffer-select > option:selected")[0].value;$.ajax({url:"wps.json",data:{RawDataOutput:"bufferstatistics",ServiceProvider:"",metapath:"",Service:"WPS",Request:"Execute",Version:"1.0.0",Identifier:"BufferStatistics",DataInputs:"lon="+d+";lat="+c+";epsg=4326;buffer="+a},success:function(g,i,f){$("div.loading").detach();$("div.stats-data").detach();try{populateTemplates(g)}catch(h){showAlert("Oops, could not find any data!")}}})}function mapOnClick(a){var b=a.latlng.lat;var c=a.latlng.lng;setLocation(c,b)}var map=L.map("map");if(typeof lat!="undefined"&&typeof lon!="undefined"&&typeof zoom!="undefined"){map.setView([lat,lon],zoom)}else{if(typeof mlat!="undefined"&&typeof mlon!="undefined"){map.setView([mlat,mlon],10)}else{map.setView([0,0],2)}}var baselayer=L.tileLayer("http://otile{s}.mqcdn.com/tiles/1.0.0/map/{z}/{x}/{y}.jpg",{attribution:'Tiles Courtesy of <a href="http://www.mapquest.com/" target="_blank">MapQuest</a> <img src="http://developer.mapquest.com/content/osm/mq_logo.png">',maxZoom:17,subdomains:[1,2,3,4]});baselayer.addTo(map);var globcover_2009=L.tileLayer("http://cdetux2.unibe.ch/geoserver/gwc/service/tms/1.0.0/lo:globcover_2009@EPSG:900913@png/{z}/{x}/{y}.png",{opacity:0.6,tms:true,maxZoom:17});var accessibility=L.tileLayer("http://cdetux2.unibe.ch/geoserver/gwc/service/tms/1.0.0/lo:accessability@EPSG:900913@jpeg/{z}/{x}/{y}.png",{opacity:0.6,tms:true,maxZoom:17});var population_density=L.tileLayer("http://cdetux2.unibe.ch/geoserver/gwc/service/tms/1.0.0/lo%3Alspop_2008@EPSG%3A900913@png/{z}/{x}/{y}.png",{opacity:0.6,tms:true,maxZoom:17});var GetCurrentLocationControl=L.Control.extend({options:{position:"topright"},onAdd:function(c){var a=L.DomUtil.create("div","get-location-control");var b=L.DomUtil.create("a","get-location",a);b.href="#";L.DomEvent.on(a,"click",function(d){c.off("click",mapOnClick);if("geolocation" in navigator){navigator.geolocation.getCurrentPosition(function(f){var e=f.coords;c.panTo([e.latitude,e.longitude]);setLocation(e.longitude,e.latitude)},function(e){showAlert(e.message)},{enableHighAccuracy:true,timeout:10000,maximumAge:100000})}else{showAlert("Geolocation is not available in your browser")}});L.DomEvent.on(a,"mouseout",function(d){c.on("click",mapOnClick)});return a}});map.addControl(new GetCurrentLocationControl());var ShareControl=L.Control.extend({options:{position:"topright"},onAdd:function(c){var a=L.DomUtil.create("div","share-control");var b=L.DomUtil.create("a","",a);b.href="#";L.DomEvent.on(a,"click",function(h){c.off("click",mapOnClick);if(typeof marker!="undefined"){var d=marker.getLatLng();var g=Fgh.encode(d.lat,d.lng,52);var f=g;document.location.href=f}else{showAlert("Add first a location! Click the map to set the location or input coordinates in the form below the map.")}});L.DomEvent.on(a,"mouseout",function(d){c.on("click",mapOnClick)});return a}});map.addControl(new ShareControl());L.control.layers({},{'Global landcover&nbsp;<a href="#"><i class="fa fa-info-circle" id="globcover_2009"></i></a>':globcover_2009,'Landscan population density&nbsp;<a href="#"><i class="fa fa-info-circle"></i></a>':population_density,'Accessibility: travel time to major cities&nbsp;<a href="#"><i class="fa fa-info-circle"></i></a>':accessibility}).addTo(map);if(typeof mlat!="undefined"&&typeof mlon!="undefined"){setLocation(mlon,mlat)}map.on("click",mapOnClick);$("#location-input-button").click(function(b){var c=$("#longitude-input").val();var a=$("#latitude-input").val();setLocation(c,a);map.panTo(L.latLng(a,c),{animate:true})});$(".fa-info-circle").click(function(a){$("#legend-modal").modal()});(function(){var a="0123456789bcdefghjkmnpqrstuvwxyz";var d=[0,1,0,1,2,3,2,3,0,1,0,1,2,3,2,3,4,5,4,5,6,7,6,7,4,5,4,5,6,7,6,7];var b=[0,1,4,5,16,17,20,21,64,65,68,69,80,81,84,85,256,257,260,261,272,273,276,277,320,321,324,325,336,337,340,341];function f(g,h){return(a.indexOf(g.charAt(h))<<5)|(a.indexOf(g.charAt(h+1)))}function c(g){return d[g&31]|(d[(g>>6)&15]<<3)}function e(i){var g=0,h=0;while(i>0){low=i&255;g|=b[low]<<h;i>>=8;h+=16}return g}window.Fgh={decode:function(m){var h=m.length,k,j,l=0,g=0;if(h&1){j=(a.indexOf(m.charAt(h-1))<<5)}else{j=f(m,h-2)}g=(c(j))/32;l=(c(j>>1))/32;for(k=(h-2)&~1;k>=0;k-=2){j=f(m,k);g=(c(j)+g)/32;l=(c(j>>1)+l)/32}return{lat:180*(g-0.5),lon:360*(l-0.5)}},encode:function(p,h,s){p=p/180+0.5;h=h/360+0.5;var g="",m=Math.ceil(s/10),t,k,q,j,o,n;for(n=0;n<m;++n){p*=32;h*=32;t=Math.min(31,Math.floor(p));k=Math.min(31,Math.floor(h));p-=t;h-=k;q=e(t)|(e(k)<<1);j=q>>5;o=q&31;g+=a.charAt(j)+a.charAt(o)}g=g.substr(0,Math.ceil(s/5));return g},checkValid:function(g){return !!g.match(/^[0-9b-hjkmnp-z]+$/)}}})();